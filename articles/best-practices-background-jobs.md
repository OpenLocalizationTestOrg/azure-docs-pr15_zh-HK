<properties
   pageTitle="后台作业指导 |Microsoft Azure"
   description="背景指导任务运行单独的用户界面。"
   services=""
   documentationCenter="na"
   authors="dragon119"
   manager="christb"
   editor=""
   tags=""/>

<tags
   ms.service="best-practice"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="07/21/2016"
   ms.author="masashin"/>

# <a name="background-jobs-guidance"></a>后台作业指导

[AZURE.INCLUDE [pnp-header](../includes/guidance-pnp-header-include.md)]

## <a name="overview"></a>概述

许多类型的应用程序要求运行独立于用户界面 (UI) 的后台任务。 例如，批处理作业、 处理大量任务和长时间运行的流程，如工作流。 后台作业可执行而无需用户交互，应用程序可以启动该作业，然后继续处理来自用户的交互请求。 这有助于最小化应用程序的 UI，它可以提高可用性并减少了交互式响应时间上的负载。

例如，如果应用程序需要生成的用户上载的图像的缩略图，可作为后台作业执行此操作并保存到存储缩略图，完成时，用户无需等待该进程完成的情况下。 以相同的方式，订购用户可以启动处理顺序，而用户界面使用户可以继续浏览该 web 应用程序的后台工作流。 后台作业完成后，它可以更新存储的订单数据并用电子邮件发送到用户的确认订单。

当您考虑实现作为后台作业任务，主要条件是否是否该任务可以运行无需用户交互和用户界面无需等待完成作业。 需要用户或用户界面，等待它们完成任务可能不适合作为后台作业。

## <a name="types-of-background-jobs"></a>类型的后台作业

后台作业通常包括一个或多个下列类型的作业︰

- CPU 密集型作业，数学计算或结构模型分析等。
- O 大量作业，例如执行一系列存储事务或索引文件。
- 批处理作业，如夜间数据更新或计划的处理。
- 长时间运行工作流，例如订单执行，或者资源调配服务和系统。
- 敏感数据处理任务关闭传递到更安全的位置，以进行处理。 例如，您可能不希望处理 web 应用程序内的敏感数据。 相反，如[网关守卫](http://msdn.microsoft.com/library/dn589793.aspx)的模式可能用于将数据传输到有权访问受保护的存储独立的后台进程。

## <a name="triggers"></a>触发器

可以以多种不同方式启动后台作业。 他们属于以下类别之一︰

- [**事件驱动的触发器**](#event-driven-triggers)。 任务被开始在响应事件时，通常由用户或工作流中的步骤执行操作。
- [**计划驱动的触发器**](#schedule-driven-triggers)。 调用基于计时器的计划任务。 这可能是循环执行的时间表或者在以后指定的一次性调用。

### <a name="event-driven-triggers"></a>事件驱动的触发器

事件驱动的调用使用触发器来启动后台任务。 使用事件驱动触发器的示例包括︰

- 用户界面或另一个作业队列中放置消息。 该消息包含有关已发生，例如，订购用户操作的数据。 后台任务在此队列上执行侦听并检测新消息的到达。 它读取消息并作为输入到后台作业中使用的数据。
- 用户界面或另一个作业保存或更新中存储的值。 后台任务监视存储并检测到更改。 它读取数据并将其用作输入到后台作业。
- 用户界面或另一个作业到端点，例如 HTTPS 的 URI 或作为 web 服务公开的 API 发出请求。 它将作为请求的一部分完成后台任务所需的数据传送。 终结点或 web 服务调用后台任务，使用该数据作为其输入。

适合于事件驱动调用的任务的典型示例包括图像处理、 工作流，将信息发送到远程服务发送电子邮件，多租户应用程序中的新用户提供访问权限。

### <a name="schedule-driven-triggers"></a>计划驱动的触发器

计划驱动调用使用计时器来启动后台任务。 使用计划驱动的触发器的示例包括︰

- 在本地运行的应用程序中或作为应用程序的操作系统的一部分调用后台任务定期计时器。
- 运行在不同的应用程序或类似 Azure 计划的计时器服务计时器 API 或 web 服务定期发送的请求。 该 API 或 web 服务调用的后台任务。
- 一个单独的进程或应用程序启动导致后台任务，要一次指定的时间延迟后，或在指定时间调用一个计时器。

典型的适合于计划驱动调用的任务包括批处理例程 （如更新相关产品列表以供用户根据他们最近的行为），例行的数据处理任务 （如更新索引或产生积累的结果），每日报告、 数据保留清理和数据一致性检查的数据分析。

如果使用计划驱动的任务，必须作为单一实例运行时，请注意以下︰

- 如果缩放时正在运行的计划程序 （如使用 Windows 任务计划的程序的虚拟机） 的计算实例，则必须运行调度程序的多个实例。 这些无法启动任务的多个实例。
- 如果调度事件之间的时间段超过运行任务，计划程序可能启动任务的另一个实例前一个仍在运行。

## <a name="returning-results"></a>返回结果

在单独的进程，或即使在不同的位置，从 UI 或调用后台任务的过程中，异步执行后台作业。 理想情况下，后台任务"启动后不管"的操作，并且其执行进度具有不影响用户界面或调用进程。 这意味着调用进程不会等待任务的完成。 因此，它不能自动检测任务结束时。

如果您需要调用的任务，以显示进度或完成与进行通信的后台任务，您必须为此实现机制。 一些示例包括︰

- 状态指标值写入访问的用户界面或调用方任务，这样可以监视或检查此值时所需的存储。 后台任务必须向调用方返回的其他数据可以放到同一存储区。
- 建立用户界面或调用方侦听应答队列。 后台任务可以指示状态和完成的队列发送消息。 后台任务必须返回到调用方的数据可以放入邮件。 如果您正在使用 Azure 服务总线，可以使用**回复**和**都会**属性来实现此功能。 有关详细信息，请参阅[服务总线通过代理进行消息传递的相关性](http://www.cloudcasts.net/devguide/Default.aspx?id=13029)。
- 公开的 API 或用户界面或调用方可以访问以获取状态信息的后台任务从终结点。 可以在响应中包含后台任务必须返回到调用方的数据。
- 有回拨到用户界面或通过 API 调用方来指示状态的预定义点或在完成后台任务。 这可能是通过本地引发的事件或通过发布和订阅机制。 可以请求或事件有效负载中包含后台任务必须返回到调用方的数据。

## <a name="hosting-environment"></a>宿主环境

您可以通过使用一系列不同 Azure 平台服务承载后台任务︰

- [**Azure 的 Web 应用程序和 WebJobs**](#azure-web-apps-and-webjobs)。 可以使用 WebJobs 来执行基于各种不同类型的脚本或可执行程序的 web 应用程序的上下文中的自定义作业。
- [**Azure 云服务 web 和辅助角色**](#azure-cloud-services-web-and-worker-roles)。 您可以编写代码以后台任务执行的角色中。
- [**Azure 的虚拟机**](#azure-virtual-machines)。 如果您有一个 Windows 服务或想要使用 Windows 任务计划程序，很常见，来承载您的专用的虚拟机中的后台任务。
- [**Azure 的批次**](./batch/batch-technical-overview.md)。 它计划计算密集型工作，若要在托管的虚拟机的集合上运行的平台服务，可以自动比例计算资源以满足作业的需要。

以下各节描述了每个选项的详细信息，并考虑以帮助您选择适当的选项。

## <a name="azure-web-apps-and-webjobs"></a>Azure 的 Web 应用程序和 WebJobs

您可以使用 Azure WebJobs 执行作为后台任务在 Azure Web 应用程序的自定义作业。 WebJobs 在您的 web 应用程序的上下文中运行，作为一个连续的过程。 WebJobs 还运行以响应从 Azure 计划程序或外部因素，例如，更改存储 blob 和消息队列触发器事件。 可以启动和停止点播和正常关闭作业。 如果持续运行 WebJob 失败，则它自动重新启动。 配置重试和错误操作的。

当您配置 WebJob:

- 如果您想要响应的事件驱动的触发器的作业，应将它配置为**连续运行**。 站点/wwwroot/app_data/作业/连续命名的文件夹中存储的脚本或程序。
- 如果您想要响应计划驱动的触发器的作业，应将它配置为**按计划运行**。 命名网站/wwwroot/app_data/作业/触发的文件夹中存储的脚本或程序。
- 如果您选择**按需运行**选项配置作业时，它将在启动计算机时执行与**按计划运行**选项相同的代码。

在 web 应用程序的沙箱中运行 azure WebJobs。 这意味着它们可以访问环境变量并使 web 应用程序与共享信息，如连接字符串。 作业具有访问权限的计算机正在运行该作业的唯一标识符。 应用程序数据，Azure 存储队列，blob 和表的访问和访问到服务总线的消息传递和通信提供了名为**AzureWebJobsStorage**的连接字符串。 名为**AzureWebJobsDashboard**的连接字符串提供作业操作日志文件的访问权限。

Azure WebJobs 具有以下特征︰

- **安全**︰ WebJobs 受部署 web 应用程序的凭据。
- **支持的文件类型**︰ 您可以使用命令脚本 (.cmd)，批处理文件 (.bat)，PowerShell 脚本 (.ps1) 来定义 WebJobs，指责 shell 脚本 (.sh)、 PHP 脚本 (.php)、 Python 脚本 (.py)、 JavaScript 代码 (.js) 和可执行程序 （.exe、.jar，等等）。
- **部署**︰ 您可以通过使用 Azure 的门户中，通过使用[Azure WebJobs SDK](./app-service-web/websites-dotnet-webjobs-sdk-get-started.md)中，或将其复制到以下位置直接[WebJobsVs](https://visualstudiogallery.msdn.microsoft.com/f4824551-2660-4afa-aba1-1fcc1673c3d0)外接使用 Visual Studio 或[Visual Studio 2013年更新 4](http://www.visualstudio.com/news/vs2013-update4-rc-vs) （可以创建和部署具有此选项），部署脚本和可执行文件︰
  - 为触发执行︰ 站点/wwwroot/app_data/作业/触发 / {作业名称}
  - 连续执行︰ 站点/wwwroot/app_data/作业/连续 / {作业名称}
- **日志记录**︰ Console.Out 作为信息处理 （标记）。 Console.Error 将被视为错误。 可以通过使用 Azure 门户访问监视和诊断信息。 您可以直接从该网站下载日志文件。 它们保存在以下位置︰
  - 为触发执行︰ Vfs/数据/工作/触发/jobName
  - 连续执行︰ Vfs/数据/工作/连续/jobName
- **配置**︰ 您可以通过使用 REST API，PowerShell 门户配置 WebJobs。 一个名为 settings.job 作为作业脚本的相同根目录中的配置文件用于提供作业的配置信息。 例如︰
  - {"stopping_wait_time": 60。
  - {"is_singleton": 真}

### <a name="considerations"></a>注意事项

- 默认情况下，使用 web 应用程序的 WebJobs 比例。 但是，您可以配置单个实例上运行的**is_singleton**配置属性设置为**true**的作业。 单实例 WebJobs 可用于不需要扩展或运行方式同时进行多任务情况下，例如重建索引、 数据分析和相似的任务。
- 作业的 web 应用程序的性能的影响降至最低，可以考虑创建占用主机可能是长时间运行的 WebJobs 或资源的新应用程序服务计划空 Azure Web 应用程序实例。

### <a name="more-information"></a>详细信息

- [Azure WebJobs 建议资源](./app-service-web/websites-webjobs-resources.md)列出了许多有用的资源、 下载和样本 WebJobs。

## <a name="azure-cloud-services-web-and-worker-roles"></a>Azure 的云服务 web 和工作人员的角色

您可以执行后台任务 web 角色中或在单独的辅助角色。 当您决定是否使用辅助角色，请考虑可伸缩性和弹性要求、 任务的生存期时，释放节奏、 安全、 容错、 争夺、 复杂性和逻辑体系结构。 有关详细信息，请参阅[计算资源整合模式](http://msdn.microsoft.com/library/dn589778.aspx)。

有多种方法来实现云服务角色中的后台任务︰

- 在角色中创建**RoleEntryPoint**类的实现和使用它的方法来执行后台任务。 WaIISHost.exe 的上下文中运行的任务。 **CloudConfigurationManager**类的**GetSetting**方法可用于加载配置设置。 有关详细信息，请参阅[生命周期 （云服务）](#lifecycle-cloud-services)。
- 启动任务用于在应用程序启动时执行后台任务。 若要强制继续在后台运行的任务，请将**taskType**属性设置为**背景**（如果不这样做，在应用程序启动过程将暂停并等待要完成的任务）。 有关详细信息，请参见[运行在 Azure 中的启动任务](./cloud-services/cloud-services-startup-tasks.md)。
- 使用 WebJobs SDK 实现后台任务，如启动以启动任务的 WebJobs。 有关详细信息，请参阅[开始使用 Azure WebJobs SDK](./app-service-web/websites-dotnet-webjobs-sdk-get-started.md)。
- 使用启动任务来安装 Windows 服务执行一个或多个后台任务。 必须为**背景**设置**taskType**属性，以便服务在后台执行。 有关详细信息，请参见[运行在 Azure 中的启动任务](./cloud-services/cloud-services-startup-tasks.md)。

### <a name="running-background-tasks-in-the-web-role"></a>Web 角色以运行后台任务

Web 角色以运行后台任务的主要优点是保存为托管费用，因为不需要部署更多的角色。

### <a name="running-background-tasks-in-a-worker-role"></a>在辅助角色中运行后台任务

在辅助角色中运行后台任务有几个优点︰

- 它允许您管理比例分别为每种类型的角色。 例如，您可能需要多个实例的 web 角色以支持当前的负载，但执行后台任务的辅助角色实例更少。 通过后台任务计算实例分别从 UI 角色的缩放比例，可以减少托管成本，同时保持可接受的性能。
- 它不通过 web 角色从后台任务的处理开销。 提供用户界面的 web 角色可以保持响应状态，而且这可能意味着需要更少的实例来支持给定的卷来自用户的请求。
- 它可以实现关注点分离。 每个角色类型可以实现一组特定的明确定义和相关任务。 这样设计和维护代码更容易，因为有较少的代码和每个角色的功能的相互依赖关系。
- 它可以帮助找出敏感流程和数据。 例如，实现用户界面的 web 角色不需要访问数据的管理和控制的辅助角色。 这可以有助于加强安全，尤其是当使用[网关守卫模式](http://msdn.microsoft.com/library/dn589793.aspx)等模式。  

### <a name="considerations"></a>注意事项

选择如何以及在何处时，请考虑以下几点来部署后台任务时使用云服务网站和工作人员角色︰

- 驻留在现有 web 角色的后台任务可以保存运行这些任务只是单独的工作角色的成本。 但是，很可能会影响性能和可用性的应用程序，如果处理和其他资源的争夺。 使用单独的工作角色保护 web 角色从长时间运行或资源密集型的后台任务的影响。
- 如果您通过使用**RoleEntryPoint**类宿主后台任务，您可以轻松地移动这给另一个角色。 例如，如果 web 角色中创建的类，而稍后需要辅助角色中运行的任务，可以到辅助角色移动**RoleEntryPoint**类的实现。
- 启动任务旨在执行程序或脚本。 部署的可执行程序作为后台作业可能更为困难，尤其是它还需要依赖程序集的部署。 它可能是易于部署和使用一个脚本来定义后台作业时使用启动任务。
- 导致失败的后台任务的异常有不同的影响，根据它们所承载的方式︰
  - 如果使用**RoleEntryPoint**类方法，失败的任务将导致重新启动，以便自动重新启动该任务的角色。 这可能会影响应用程序的可用性。 要防止出现这种情况，请确保包括可靠的异常处理中的**RoleEntryPoint**类和所有后台任务。 使用代码来重新启动任务，这是适当的失败并引发异常，以便仅当您不能适当地从故障中恢复在代码中重新启动该角色。
  - 如果使用启动任务，您有责任管理任务执行和检查如果该操作失败。
- 管理和监视启动任务是使用**RoleEntryPoint**类方法相比更加困难。 但是，Azure WebJobs SDK 中包含的仪表板，以方便您管理您启动通过启动任务的 WebJobs。

### <a name="more-information"></a>详细信息

- [计算资源整合模式](http://msdn.microsoft.com/library/dn589778.aspx)
- [开始使用 Azure WebJobs SDK](./app-service-web/websites-dotnet-webjobs-sdk-get-started.md)

## <a name="azure-virtual-machines"></a>Azure 的虚拟机

这些选项可能不方便或后台任务可能实现禁止它们部署到 Azure 的 Web 应用程序和云服务的方式。 典型的示例是 Windows 服务和第三方实用程序和可执行程序。 另一个例子可能是不同于所承载应用程序的执行环境中编写的程序。 例如，可能希望从 Windows 或.NET 应用程序中执行 Unix 或 Linux 的程序。 可以选择从 Azure 的虚拟机的操作系统的区域，在该虚拟机上运行您的服务或可执行文件。

为了帮助您选择何时使用虚拟机，请参阅[Azure 应用程序服务、 云服务和虚拟机的比较](./app-service-web/choose-web-site-cloud-service-vm.md)。 有关虚拟机的选项的信息，请参阅[Azure 的大小的虚拟机和云服务](http://msdn.microsoft.com/library/azure/dn197896.aspx)。 有关操作系统和可用的虚拟机的预生成的图像的详细信息，请参阅[Azure 虚拟机市场](https://azure.microsoft.com/gallery/virtual-machines/)。

要启动后台任务在单独的虚拟机中，有一系列选项︰

- 您可以执行该任务按需直接从您的应用程序通过将请求发送到任务公开的终结点。 这通过在任务所需的任何数据。 此端点调用该任务。
- 您可以配置要使用计划程序或在您选定的操作系统中可用的计时器按计划运行的任务。 例如，在 Windows 上可以使用 Windows 任务计划程序来执行脚本和任务。 或者，如果您的 SQL Server 安装在虚拟机上，可以使用 SQL Server 代理程序中执行脚本和任务。
- 您可以使用 Azure 计划程序队列任务的侦听，加上一条消息，或者将请求发送到该任务公开 API 启动任务。

请参阅前面一节[触发器](#triggers)有关如何可以启动后台任务。  

### <a name="considerations"></a>注意事项

在决定是否部署 Azure 的虚拟机中的后台任务时，请考虑以下几点︰

- 驻留在一个单独的 Azure 虚拟机的后台任务提供了灵活性，并允许启动、 执行、 调度和资源分配的精确控制。 但是，必须将虚拟机部署只是为了运行后台任务时将增大运行时开销。
- 任何工具来监视在 Azure 的门户和失败任务 — 的没有自动重启功能的任务，虽然可以监视虚拟机的基本状态，并通过使用[Azure 服务管理 Cmdlet](http://msdn.microsoft.com/library/azure/dn495240.aspx)来管理它。 但是，没有设施，以控制进程和线程中计算节点。 通常，使用虚拟机将需要额外的工作来实现从检测在任务中，并从虚拟机中的操作系统收集数据的机制。 可能适用的一种解决方案是使用[Azure 系统中心管理包](http://technet.microsoft.com/library/gg276383.aspx)。
- 您可以考虑创建监视通过 HTTP 的终结点公开的探测器。 这些探测器的代码无法执行运行状况检查、 收集操作信息和统计信息 — 或逐份打印错误的信息并将其返回到一个管理应用程序。 有关详细信息，请参阅[健康终结点监视模式](http://msdn.microsoft.com/library/dn589789.aspx)。

### <a name="more-information"></a>详细信息

- 在 Azure 上的[虚拟机](https://azure.microsoft.com/services/virtual-machines/)
- [Azure 的虚拟机的常见问题解答](virtual-machines/virtual-machines-linux-classic-faq.md)

## <a name="design-considerations"></a>设计考虑事项

有几个设计后台任务时需要考虑的基本因素。 以下各节讨论分区、 冲突和协调。

## <a name="partitioning"></a>分区

如果您决定包括后台任务 （如 web 应用程序、 web 角色、 现有辅助角色或虚拟机） 现有计算实例中的，您必须考虑，这将如何影响的计算实例和后台任务本身的质量特性。 这些因素将帮助您决定是否要协同定位的任务与现有的计算实例，或将它们分离到单独的计算实例︰

- **可用性**︰ 后台任务可能不需要用户界面和用户交互中直接涉及其他部分尤其是具有相同级别的可用性作为应用程序的其他部分。 后台任务可能更能容忍延迟、 重试的连接故障，因为可以排队操作的其他因素的影响可用性。 但是，必须有足够的容量以防止无法阻止队列而影响整个应用程序的请求的备份。
- **可伸缩性**︰ 后台任务很可能会有不同的可伸缩性要求以外的用户界面和交互的应用程序部分。 扩展用户界面可能需要满足高峰需求，而由到数量较少，可能少繁忙时完成未完成后台任务数量计算实例。
- **弹性**︰ 失败的只是承载后台任务计算实例可能不严重会影响整个应用程序如果可以排队或推迟任务再次可用之前对这些任务的请求。 如果在适当的时间间隔内的计算实例和/或任务可以被重新启动，可能不会影响应用程序的用户。
- **安全**︰ 后台任务可能具有不同的安全要求或限制条件比用户界面或应用程序的其他部分。 通过使用不同的计算实例，您可以指定一个不同的安全环境的任务。 您可以使用模式，如网关守卫才能最大限度地安全和分色分离用户界面中的后台计算实例。
- **性能**︰ 您可以选择计算实例的类型的后台任务到专门的匹配任务的性能要求。 这可能意味着如果任务不需要与用户界面或更大的实例相同的处理能力如果他们需要更多容量和资源使用成本较低的计算选项。
- **可管理性**︰ 后台任务可能具有不同的开发和部署旋律从主应用程序代码或用户界面。 更新和版本控制，可以简化部署到单独的计算实例。
- **成本**︰ 添加计算实例，以执行后台任务增加托管费用。 您应仔细考虑附加的容量和这些额外的成本之间的平衡。

有关详细信息，请参阅[领导者选举模式](http://msdn.microsoft.com/library/dn568104.aspx)和[竞争使用者模式](http://msdn.microsoft.com/library/dn568101.aspx)。

## <a name="conflicts"></a>冲突

如果您有后台作业的多个实例，则可能会将竞相访问资源和服务，如数据库和存储。 这种同时访问可能会导致资源争用，这可能会造成冲突，在服务的可用性和存储中的数据的完整性。 您可以通过使用悲观锁定方法解决资源争用。 这会阻止竞争对手的实例同时访问服务或破坏数据的任务。

另一种方法来解决冲突是作为单一实例，定义后台任务，以便永远都只有一个实例正在运行。 但是，这就消除了多个实例配置可以提供的可靠性和性能好处。 这是尤其如此，如果用户界面可以提供足够的工作，以使多个后台任务处于繁忙状态。

关键是要确保后台任务可以自动重新启动，并且它有足够的容量，以应付需求的高峰期。 您可以通过分配充足的资源，与计算实例，通过实施可以存储供以后执行当需求下降，请求排入队列机制或通过使用这些技术的组合来达到此目的。

## <a name="coordination"></a>协调

后台任务可能非常复杂，可能需要多个单个任务执行要产生一个结果，或可以满足所有的要求。 很普遍，在这些情况下，若要将该任务划分为较小的离散步骤或可以由多个使用者执行的子任务。 多步骤的作业可能会更有效、 更灵活，因为个别步骤可能是可重复使用的多个职位。 也很容易地添加、 删除或修改步骤的顺序。

协调多个任务和步骤会很困难，但可用于指导您的解决方案的实现的三种常见模式︰

- **分解成多个可重复使用的步骤的任务**。 应用程序可能需要处理的信息执行各种任务的复杂程度各异。 一种比较简单，但不够灵活的方法来实现此应用程序可能会执行此处理作为单一的模块。 但是，这种方法可能会减少代码重构、 优化它，或重新使用它的相同处理部分是否需要对应用程序内的其他地方的机会。 有关详细信息，请参阅[管道和筛选器模式](http://msdn.microsoft.com/library/dn568100.aspx)。
- **管理任务的步骤执行**。 应用程序可能会执行包含多个步骤 （其中一些可能会调用远程服务或访问远程资源） 的任务。 各个步骤可能是独立的但他们统一协调，实现任务的应用程序逻辑。 有关详细信息，请参阅[计划代理主管模式](http://msdn.microsoft.com/library/dn589780.aspx)。
- **管理任务步骤的失败的恢复**。 应用程序可能需要撤消通过一系列步骤 （它们一起定义最终一致操作） 执行的工作的一个或多个步骤失败。 有关详细信息，请参阅[补偿事务模式](http://msdn.microsoft.com/library/dn589804.aspx)。

## <a name="lifecycle-cloud-services"></a>生命周期 （云服务）

 如果您决定实现通过使用**RoleEntryPoint**类使用 web 和员工角色的云服务应用程序的后台作业，务必要正确使用它了解此类的生命周期。

Web 和员工角色穿过一套不同的阶段，如启动、 运行，并停止。 **RoleEntryPoint**类公开一系列指示何时将这些阶段发生的事件。 使用这些来初始化，请运行，并停止您自定义的后台任务。 完整的周期是︰

- Azure 角色集加载并搜索它从**RoleEntryPoint**派生的类。
- 如果找到此类，它将调用**RoleEntryPoint.OnStart()**。 重写此方法以初始化后台任务。
- **OnStart**方法完成后，如果此应用程序的全局文件中的**Application_Start()**是 Azure 调用显示 （例如，在运行 ASP.NET web 角色 Global.asax）。
- Azure 上与**OnStart()**并行执行的新的前台线程调用**RoleEntryPoint.Run()** 。 重写此方法来启动后台任务。
- Run 方法结束时，Azure 首先调用**Application_End()**应用程序的全局文件中如果这是存在的，然后调用**RoleEntryPoint.OnStop()**。 停止后台任务，清理资源、 释放对象，并关闭可能使用任务的连接的**OnStop**方法重写。
- Azure 的工作角色主机进程已停止。 在这种情况下，该角色将被回收并将重新启动。

有关更多详细信息，并使用**RoleEntryPoint**类的方法的示例，请参阅[计算资源整合模式](http://msdn.microsoft.com/library/dn589778.aspx)。

## <a name="considerations"></a>注意事项

当您计划如何将 web 或辅助角色中运行后台任务时，请考虑以下几点︰

- 中的默认**运行**方法实现**RoleEntryPoint**类包含调用**Thread.Sleep(Timeout.Infinite)**使角色保持无限期地保持活动状态。 如果您重写**Run**方法 （这是通常需要执行后台任务），您不得允许您的代码以从方法退出，除非您想要回收的角色实例。
- **Run**方法的典型实现包括启动每个后台任务和循环构造来定期检查所有后台任务的状态代码。 它可以重新启动任何失败或监视的取消标记，指示作业已完成。
- 如果后台任务引发了未处理的异常，同时允许在继续运行的角色的任何其他后台任务应回收任务。 但是，如果异常由损坏的对象以外的任务，如共享存储，应该通过**RoleEntryPoint**类来处理该异常，应取消所有任务，并且应允许**Run**方法结束。 Azure 然后将重新启动该角色。
- 使用**OnStop**方法暂停或终止后台任务和清理资源。 这样做可能会停止运行时间较长或多步骤的任务。 关键是要考虑如何将这种以避免数据不一致。 如果用户启动的关机以外的任何原因停止角色实例，必须强行终止前的五分钟之内完成**OnStop**方法中运行的代码。 确保您的代码可以在该时间内完成，或能够容忍不运行到完成。  
- Azure 负载平衡器将启动将流量引向角色实例时**RoleEntryPoint.OnStart**方法返回值**，则返回 true**。 因此，请考虑将所有初始化代码都放入**OnStart**方法，以便成功地初始化的角色实例将不会收到任何通信。
- 您可以使用启动任务和**RoleEntryPoint**类的方法。 启动任务应该用于初始化您需要更改在 Azure 负载平衡器，因为该角色获得的任何请求之前，将执行这些任务的任何设置。 有关详细信息，请参见[运行在 Azure 中的启动任务](./cloud-services/cloud-services-startup-tasks.md)。
- 如果在启动任务时出现错误，它可能会强制角色不断地重新启动。 这可以防止由于交换需要独占访问角色执行虚拟 IP (VIP) 地址换回以前分阶段版本。 重新启动该角色时，这不能获得。 若要解决此问题︰
    -  将下面的代码添加到您角色中的**OnStart**和**运行**方法的开头︰

    ```C#
    var freeze = CloudConfigurationManager.GetSetting("Freeze");
    if (freeze != null)
    {
        if (Boolean.Parse(freeze))
        {
            Thread.Sleep(System.Threading.Timeout.Infinite);
        }
    }
    ```

   - 添加定义的**冻结**设置布尔值的形式 ServiceDefinition.csdef 和服务配置。*为该角色的.cscfg 文件并将其设置为**假**.如果角色进入反复重启模式中，您可以将设置更改为**真** 冻结角色执行并允许它与以前的版本被换。

## <a name="resiliency-considerations"></a>可恢复性注意事项

后台任务必须有弹性，为了提供对应用程序的可靠服务。 当您正在规划和设计的后台任务时，请考虑以下几点︰

- 后台任务必须能够妥善处理角色或服务重新启动，而不会损坏数据或应用程序中引入不一致。 对于长时间运行或多步骤的任务，请考虑使用_检查指向_保存作业的状态，在持久存储中，或作为一个队列中的消息如果这是合适的。 例如，可以将保留在队列中的消息的状态信息和增量更新任务进度与此状态信息，以便可以从上一个已知良好检查点-而不是从头重新启动处理任务。 当使用 Azure 服务总线队列时，可以使用邮件会话启用相同的情形。 会话，可以保存并使用[SetState](http://msdn.microsoft.com/library/microsoft.servicebus.messaging.messagesession.setstate.aspx)和[GetState](http://msdn.microsoft.com/library/microsoft.servicebus.messaging.messagesession.getstate.aspx)方法来检索应用程序处理状态。 有关设计可靠的多步骤过程和工作流的详细信息，请参阅[计划代理主管模式](http://msdn.microsoft.com/library/dn589780.aspx)。
- 当您使用 web 或工作人员的角色来承载多个后台任务时，设计要为失败或停止任务监控和重新启动它们的**运行**方法的重写。 这是不实际的且使用的辅助角色，强制重新启动通过从**Run**方法退出辅助角色。
- 当使用队列进行通信的后台任务，队列可以作为一个缓冲区来存储请求发送到该应用程序时的任务是在负荷比高下。 这使得更少忙期间与 UI 追赶的任务。 这也意味着，回收该角色将不会阻止用户界面。 有关详细信息，请参阅[基于队列的负载调配操作模式](http://msdn.microsoft.com/library/dn589783.aspx)。 如果某些任务比其他人更重要，请考虑实现[优先级队列模式](http://msdn.microsoft.com/library/dn589794.aspx)以确保这些任务运行之前不太重要的。
- 启动消息或处理消息的后台任务必须能够处理不一致现象，如不按顺序到达的消息、 重复导致错误 （通常称为_有害消息_） 的消息和消息传送一次。 请考虑下列情况︰
  - 必须按特定的顺序，比如那些更改 （例如，将一个值添加到现有值） 的现有数据值的数据进行处理，不可能按其中发送原始顺序到达的消息。 或者，他们可能通过后台任务以不同的顺序，由于每个实例上的负载变化的不同实例来处理。 必须按特定顺序处理消息，应包括序列号、 密钥或某些其他指示器，可用于确保按正确的顺序处理后台任务。 如果您正在使用 Azure 服务总线，可以使用邮件会话以保证交货的订单。 但是，它是通常效率更高，如有可能，设计过程，以便消息顺序并不重要。
  - 通常情况下，后台任务将查看临时从其他消息使用者隐藏其队列中的消息。 然后它删除邮件后已成功地处理它们。 如果后台任务失败处理邮件时，该消息在 peek 超时到期后将再次出现在队列中。 它将处理的任务或在此实例的下一个处理周期期间的另一个实例。 如果消息以一致的方式导致使用者中的错误，它将队列满时阻塞任务、 队列中，并最终应用程序本身。 因此，其关键是要检测和有害消息从队列中移除。 如果您正在使用 Azure 服务总线，导致出现错误的邮件可以移动自动或手动到相关联的死信队列。
  - _至少有一次_交付机制，在保证队列，但是不止一次，他们可能会提供相同的消息。 此外，如果在处理一条消息，但在从队列中删除之前，后台任务失败，邮件将成为可供再次处理。 后台任务应该是等幂的这意味着，不止一次处理相同的消息不会导致错误或不一致的应用程序数据中。 某些操作自然是幂等，如将存储的值设置为一个特定的新值。 但是，操作，如添加到现有存储值而无需检查其存储的数值仍最初发送邮件相同的值将导致不一致的情况。 可以将 azure 服务总线队列配置为自动删除重复的邮件。
  - 某些消息传递系统中的，如 Azure 存储和 Azure 服务总线队列支持 de-queue count 属性，它指示已从队列中读取消息的次数。 这可以适用于处理重复和有害消息。 有关详细信息，请参见[异步消息传递的初级读本](http://msdn.microsoft.com/library/dn589781.aspx)和[幂等性模式](http://blog.jonathanoliver.com/2010/04/idempotency-patterns/)。

## <a name="scaling-and-performance-considerations"></a>伸缩和性能考虑事项

后台任务必须提供足够的性能，以确保它们不阻止该应用程序或系统的负载时，会导致由于延迟的操作不一致。 通常情况下，按比例计算实例驻留在后台任务的性能得到改进。 您在规划和设计的后台任务时, 要考虑以下几点可伸缩性和性能︰

- Azure 支持自动缩放 （横向扩展和重新缩放） 根据当前的需要和负载 — 或预定的时间表，在 Web 应用程序的云服务 web 和辅助角色和虚拟机托管部署。 使用此功能来确保应用程序作为一个整体，有足够的工作能力时运行成本降至最低。
- 在后台任务具有不同的性能功能从一个云服务的应用程序 （例如，用户界面或组件，例如数据访问层） 的其他部分，承载在单独的辅助角色中一起在后台任务允许用户界面和后台任务的角色，以独立扩展来管理负载。 如果多个后台任务有彼此明显不同的工作能力，请考虑将它们划分为单独的工作角色和单独扩展每个角色类型。 但是，请注意这可能会增加运行时成本与将所有任务都合并到更少的角色。
- 只需扩展角色可能不足以防止在负载下的性能损失。 您可能还需要扩展存储队列和其他资源以防止单点的整个处理链将成为一个瓶颈。 另外，还要考虑其他限制，例如存储和应用程序和后台任务依赖于其他服务的最大吞吐量。
- 后台任务必须用于缩放。 例如，他们必须能够动态检测中使用来侦听或将消息发送到相应的队列的存储队列的数目。
- 默认情况下，与它们相关联的 Azure Web 应用程序实例的 WebJobs 比例。 但是，如果您希望为只能运行一个实例以运行 WebJob，可以创建一个包含 JSON 数据的 Settings.job 文件**{"is_singleton": 真}**。 这将强制 Azure，只能运行一个实例的 WebJob，即使有关联的 web 应用程序的多个实例。 这可以是很有用的技术的计划作业，必须作为单一实例运行。

## <a name="related-patterns"></a>相关的模式

- [异步消息传递的初级读本](http://msdn.microsoft.com/library/dn589781.aspx)
- [自动缩放指南](http://msdn.microsoft.com/library/dn589774.aspx)
- [补偿事务模式](http://msdn.microsoft.com/library/dn589804.aspx)
- [竞争使用者模式](http://msdn.microsoft.com/library/dn568101.aspx)
- [计算分区指南](http://msdn.microsoft.com/library/dn589773.aspx)
- [计算资源整合模式](http://msdn.microsoft.com/library/dn589778.aspx)
- [网关守卫模式](http://msdn.microsoft.com/library/dn589793.aspx)
- [领导选举模式](http://msdn.microsoft.com/library/dn568104.aspx)
- [管道和筛选器模式](http://msdn.microsoft.com/library/dn568100.aspx)
- [优先级队列模式](http://msdn.microsoft.com/library/dn589794.aspx)
- [基于队列的负载调节模式](http://msdn.microsoft.com/library/dn589783.aspx)
- [计划代理主管模式](http://msdn.microsoft.com/library/dn589780.aspx)

## <a name="more-information"></a>详细信息

- [缩放与辅助角色的 Azure 应用程序](http://msdn.microsoft.com/library/hh534484.aspx#sec8)
- [执行后台任务](http://msdn.microsoft.com/library/ff803365.aspx)
- [Azure 角色启动生命周期](http://blog.syntaxc4.net/post/2011/04/13/windows-azure-role-startup-life-cycle.aspx)（日志）
- [Azure 的云服务角色生命周期](http://channel9.msdn.com/Series/Windows-Azure-Cloud-Services-Tutorials/Windows-Azure-Cloud-Services-Role-Lifecycle)（视频）
- [开始使用 Azure WebJobs SDK](./app-service-web/websites-dotnet-webjobs-sdk-get-started.md)
- [Azure 队列和服务总线队列-相对和比较](./service-bus-messaging/service-bus-azure-and-service-bus-queues-compared-contrasted.md)
- [如何启用诊断在云服务中](./cloud-services/cloud-services-dotnet-diagnostics.md)
