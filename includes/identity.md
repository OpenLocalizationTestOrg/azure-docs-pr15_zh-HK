管理标识是一样重要在公共云上部署。 为了做到这一点，Azure 支持几种不同的云标识技术。 它们包括︰

- 您可以在云中使用使用 Azure 虚拟机创建的虚拟机运行 Windows 服务器活动目录 （通常称为只是广告）。 这种方法使用 Azure 将内部数据中心扩展到云时意义。


- 可以使用 Azure Active Directory 来给您的用户单一登录[软件即服务 (SaaS)](https://azure.microsoft.com/overview/what-is-saas/)应用程序。 例如，微软 Office 365 提供使用这种技术，而其他云平台 Azure 上运行的应用程序也可以使用它。


- 在云中还是内部运行的应用程序可以使用标识从 Facebook、 Google、 微软和其他标识提供程序的允许的用户登录到使用 Azure 活动目录的访问控制。


本文介绍了这三个选项。

## <a name="table-of-contents"></a>目录

- [在虚拟机中运行的 Windows 服务器活动目录](#adinvm)

- [使用 Azure 的活动目录](#ad)

- [使用 Azure Active Directory 访问控制](#ac)


## <a name="adinvm"></a>在虚拟机中运行的 Windows 服务器活动目录

在 Azure 的虚拟机中运行 Windows Server 广告非常类似于内部运行它。 [图 1](#fig1)显示了一个典型的例子的效果。

![Azure 的 Active Directory 中的虚拟机](./media/identity/identity_01_ADinVM.png)


<a name="Fig1"></a>图 1: Windows 服务器的 Active Directory 可以在 Azure 连接到使用 Azure 虚拟网络组织的内部数据中心的虚拟机中运行。

此处所示的示例中，在 Windows 服务器 AD 使用 Azure 的虚拟机，该平台的 IaaS 技术创建的虚拟机中运行。 这些虚拟机和其他几种划分虚拟网络连接到使用 Azure 虚拟网络的内部数据中心。 出云通过虚拟专用网络 (VPN) 连接的内部网络进行交互的虚拟机的一组 carves 的虚拟网络。 做这样这些 Azure 的虚拟机的外观到内部数据中心只是另一个子网。 如图所示，这些虚拟机中的两个运行 Windows 服务器 AD 域控制器。 虚拟的网络中的其他虚拟机可能在运行应用程序，如 SharePoint，或正被用作以某种其他方式，例如用于开发和测试。 内部数据中心也正在运行两个 Windows 服务器 AD 域控制器。

有几个选项用于连接与运行在云环境中的域控制器︰

- 将它们全部一个 Active Directory 域的一部分。

- 创建单独 AD 域内部和在云中属于同一个林。

- 在云和内部部署中创建单独的广告目录林中，然后连接目录林使用跨林信任或 Windows 服务器 Active Directory 联合身份验证服务 (AD FS)，它可以在 Azure 上运行在虚拟机中。

进行任何选择，管理员应确保来自内部用户的身份验证请求进入云域控制器仅在必要时，由于云的链接很可能比内部网络速度较慢。 在连接云和内部域控制器时需要考虑的另一个因素是复制生成的通信量。 在自己 AD 站点中，它允许管理员安排频率通常是在云环境中的域控制器进行复制。 尽管不为字节发送中，这可能会影响管理员的复制选择 Azure 数据中心，从发送的通信的 azure 费用。 它也是值得指出 Azure 提供其自己的域名系统 (DNS) 支持，而该服务缺少功能所需的活动目录 （例如，动态 DNS 和 SRV 记录的支持）。 正因为如此，在 Azure 上运行 Windows Server 广告需要设置自己的 DNS 服务器群中。

在 Azure 的虚拟机中运行 Windows Server 广告可以意义在几种不同的情况下。 下面是一些示例︰

- 如果您使用 Azure 的虚拟机作为您自己的数据中心扩展，可能需要本地域控制器来处理诸如 Windows 集成身份验证请求或 LDAP 查询云中来运行应用程序。 SharePoint，例如，经常与交互活动目录中，并因此可能要使用内部部署目录的 Azure 上运行 SharePoint 服务器场时，设置在云环境中的域控制器能够显著提高性能。 （这是一定要意识到这并不一定是必需的然而; 很多应用程序可以成功运行在云中使用仅内部域控制器）

- 假设的远分支机构缺少资源来运行其自己的域控制器。 如今，它的用户必须到世界另一边的域控制器进行身份验证-登录速度很慢。 在深入了解 Microsoft 数据中心在 Azure 上运行 Active Directory 可以加快这不需要分支办公室中的多个服务器。

- 用于灾难恢复使用 Azure 的组织可能会维护少量活动虚拟机在云中，包括域控制器。 然后准备展开此站点，根据需要可以接管故障在其他地方。

此外，还存在其他可能性。 例如，您不需要在云环境中的 Windows 服务器 AD 连接的内部数据中心。 如果您想要运行 SharePoint 服务器场提供一组特定的用户，例如，所有的人将只使用基于云的身份登录，可以在 Azure 上创建一个独立的目录林。 使用这种技术的方式取决于您的目标是什么。 （有关更多详细指导使用 Azure，[这里看到](http://msdn.microsoft.com/library/windowsazure/jj156090.aspx)Windows 服务器 AD。）

## <a name="ad"></a>使用 Azure 的活动目录

随着 SaaS 应用程序变得越来越常见，它们会引发一个显而易见的问题︰ 哪种类型的目录服务应这些基于云的应用程序使用？ 微软对此问题的答案是 Azure 活动目录。

有的在云环境中使用此目录服务的两个主要选项︰

- 个人和企业使用只有 SaaS 应用程序可以利用 Azure Active Directory 作为其唯一的目录服务。

- 运行 Windows 服务器的 Active Directory 的组织可以将其内部目录连接到 Azure Active Directory，然后用它来给他们的用户单一登录 SaaS 应用程序。


[图 2](#fig2)显示了这两个选项，其中 Azure Active Directory 是所有所需的第一个。

![Azure 的 Active Directory 中的虚拟机](./media/identity/identity_02_AD.png)

<a name="fig2"></a>图 2: Azure Active Directory 组织用户单一登录提供 SaaS 应用程序，包括 Office 365。

如图所示，Azure 的广告是一种多租户服务。 这意味着它可以同时支持多个不同的组织，存储在每个用户的目录信息。 在此示例中，组织中的用户试图访问 SaaS 应用程序。 此应用程序可能是 Office 365，如 SharePoint Online 的一部分或它可能是其他-非 Microsoft 应用程序也可以使用这种技术。 由于 Azure 的广告支持 SAML 2.0 协议，已从应用程序所需的所有是进行交互使用此行业标准的能力。 （事实上，使用 Azure AD 的应用程序可以运行在任何数据中心，而不仅仅是 Azure 数据中心中。

当用户访问 SaaS 应用程序 （步骤 1） 开始进程。 若要使用此应用程序，用户必须出示令牌颁发者 Azure 的广告。

此标记包含的信息可用于标识用户，并由 Azure 广告数字签名。 若要获取令牌，用户可验证自己到 Azure 广告通过提供用户名和密码 （步骤 2）。 Azure 广告然后返回标记他需要 （步骤 3）。

然后，此标记被发送到的 SaaS 应用程序 （步骤 4） 中，验证该令牌签名，并使用其内容 （步骤 5）。 通常情况下，应用程序将使用的令牌包含来决定哪些信息访问，并可能以其他方式允许用户的标识信息。

如果应用程序需要更多用户信息比在标记中包含的内容，它可以直接从 Azure AD 使用 Azure 广告图形 API （步骤 6） 请求。 在 Azure AD 的初始版本中，目录架构是非常简单︰ 它包含用户和组以及它们之间的关系。 应用程序可以使用此信息来了解用户之间的连接。 例如，假设应用程序需要知道谁是此用户的经理决定是否他已允许一些区块的数据访问。 它可以通过查询通过图形 API 的 Azure 广告了解此。

Graph API 使用普通的 rest 风格协议，这使它容易使用的大多数客户来说，包括移动设备。 API 还支持通过 OData 中，添加诸如查询语言中更有用的方式让客户端访问数据定义的扩展。 （OData 的详细信息，请参见[介绍 OData](http://download.microsoft.com/download/E/5/A/E5A59052-EE48-4D64-897B-5F7C608165B8/IntroducingOData.pdf)）。Graph API 可用于了解用户之间的关系，因为它可以让了解社交关系图嵌入到特定的组织 （这是为什么称之为 Graph API） 的 Azure 的 AD 架构的应用程序。 并验证自己的身份到 Azure AD 的图形 API 请求，应用程序应当使用 OAuth 2.0。

如果组织不使用 Windows 服务器的 Active Directory-它没有内部部署服务器或域-并且仅依赖于使用 AD Azure 的云应用程序，使用仅此云目录会得出公司的用户单一登录到所有这些。 尚未在这种情况下获取更常见的每一天，大多数公司仍然使用内部创建与 Windows 服务器的 Active Directory 域。 Azure 广告已有用扮演着一个角色下面，如[图 3](#fig3)所示。

![Azure 的 Active Directory 中的虚拟机](./media/identity/identity_03_AD.png)
<a id="fig3"></a>图 3︰ 一个组织可以联合使用 Azure 活动目录，以便于 SaaS 应用程序及其用户单一登录的 Windows 服务器活动目录。

在这种情况下，组织 B 的用户想要访问 SaaS 应用程序。 她这样做之前，组织的目录管理员必须使用 Azure 使用 AD FS 中，如图所示的广告建立联盟关系。 这些管理员还必须配置组织的内部 Windows 服务器 AD 和 Azure 的广告之间的数据同步。 这将自动复制用户和组信息从内部目录到 Azure 的广告。 注意到这样的内容︰ 实际上，组织到云中扩展其内部目录。 组合用 Windows 服务器 AD 和 Azure 的广告，以这种方式使组织时仍有占地面积上部署并在云中可以作为单个实体，管理目录服务。

若要使用 Azure 的广告，用户刚登录到她的内部部署 Active Directory 域照常 （步骤 1）。 当她试图访问 SaaS 应用程序 （步骤 2） 时，联合身份验证过程会导致 Azure 广告发出她的 （步骤 3） 该应用程序的标记。 (有关联合身份验证的工作原理的详细信息，请参阅[窗口基于声明的身份︰ 技术和方案](http://www.davidchappell.com/writing/white_papers/Claims-Based_Identity_for_Windows_v3.0--Chappell.docx)。)在以前，此标记将包含信息可用于标识用户，并由 Azure 广告数字签名。 然后，此标记被发送到的 SaaS 应用程序 （步骤 4） 中，验证该令牌签名，并使用其内容 （步骤 5）。 并且在前一种情况下，SaaS 应用程序可以使用图形 API，以了解有关此用户的详细信息，如果有必要 （步骤 6）。

如今，Azure 的广告并不是完整的替换为内部部署 Windows 服务器 AD。 如上所述，云目录有多简单的架构，以及它还缺少能够存储信息的计算机，并支持 LDAP 组策略这样的事物。 （事实上，Windows 机器不能配置为允许用户登录到使用 Azure AD 别无良策-这不是受支持的方案。）相反，Azure AD 的初始目标包括让企业用户访问云中的应用程序而无需维护单独的登录和释放内部目录管理员手动同步其内部目录，每个组织使用的 SaaS 应用程序。 随着时间的推移，但是，希望此云目录服务，以满足更广泛的方案。

## <a name="ac"></a>使用 Azure Active Directory 访问控制

基于云的身份技术可用于解决各种问题。 Azure 的 Active Directory 会让组织用户单一登录多个 SaaS 应用程序，例如。 但是，在云环境中的标识技术也可在其他方面。

例如，假设应用程序希望让用户使用多个*身份提供程序 (IdPs)*所颁发的令牌。 如今，Facebook、 Google、 微软和其他人，包括存在大量不同的标识提供程序，应用程序经常让使用下列身份之一登录的用户。 为什么应该应用程序自寻麻烦来维护自己的用户和密码列表时改为可以依靠已有的身份呢？ 接受现有标识使生活更简单同时具有一个更少的要记住用户名和密码，用户，以及创建应用程序时，他们不再需要维护自己的用户名和密码列表的用户。

但是，虽然每个标识提供程序问题某种类型的标记，这些标记不是标准-每个 IdP 具有其自己的格式。 此外，在这些令牌中的信息还不标准。 想要接受，说所颁发的令牌、 Facebook、 Google 和微软应用程序面临着艰巨的编写唯一的代码来处理这些不同的格式。

但是，为什么这样做呢？ 为何不改为创建可以生成单个标记格式的标识信息的通用表示形式与中介？ 这种方法会使生活更简单的开发人员创建应用程序，因为他们现在需要处理只是其中一个类型的令牌。 Azure 的活动目录访问控制完全相同这是提供使用不同标记云中的中介。 [图 4](#fig4)显示了它的工作原理

![Azure 的 Active Directory 中的虚拟机](./media/identity/identity_04_IdentityProviders.png)
<a id="fig4"></a>图 4: Azure 活动目录访问控制更容易接受不同的标识提供程序所颁发的身份令牌的应用程序。

当用户在浏览器中访问该应用程序时，将开始进程。 她到她所选择的 IdP （以及应用程序还信任），将重定向应用程序。 她她自己到此 IdP，如通过验证输入的用户名和密码 （步骤 1） 中，并 IdP 返回包含有关她 （步骤 2） 信息的标记。

如图所示，访问控件支持各种不同的基于云的 IdPs，包括 Google、 Yahoo、 Facebook、 Microsoft （以前称为 Windows Live™ ID） 和任何的 OpenID 提供者所创建的帐户。 它还支持使用 Azure Active Directory 创建的标识，通过使用 AD FS 中，Windows 服务器的 Active Directory 联合身份验证。 目标是今天要讲解最常用的身份，他们是由在云或内部 IdPs 颁发。

在用户的浏览器已经从她选 IdP IdP 令牌，它向此令牌访问控制 （步骤 3）。 访问控制验证该令牌，并确保它真正颁发的此 IdP，然后创建新标记根据已为此应用程序定义的规则。 如 Azure Active Directory 访问控制是一种多租户服务，但承租人是应用程序而不是客户公司。 每个应用程序如图所示，可以获得自己的命名空间，并且可以定义有关授权以及其他的各种规则。

这些规则允许每个应用程序的管理员可定义如何从各种 IdPs 标记应转换为访问控制标记。 例如，如果不同 IdPs 用于不同类型表示用户名，访问控制规则可以转换所有这些转换为常用的用户名类型。 然后，访问控制将此新的令牌发送回浏览器 （步骤 4） 中，提交给应用程序 （步骤 5）。 访问控制标记后，应用程序将验证此标记真正颁发的访问控制，则将使用包含 （步骤 6） 的信息。

虽然该过程看起来可能有点复杂，它实际上是生命简单得多的应用程序的创建者。 而不是处理各种令牌包含不同的信息，应用程序可以接受同时仍然可以接收单个标记熟悉的信息发出的多个标识提供程序的标识。 同时，而不是要求每个应用程序配置为信任各种 IdPs，访问控制改为维护这些信任关系-应用程序只需要信任它。

值得指出，没有任何有关访问控制限制到 Windows，即它可能也很好用的 Linux 应用程序接受仅 Google 和 Facebook 的身份。 并且，即使访问控制是 Azure Active Directory 系列的一部分，您可以将它视为完全不同的服务，从上一节中所述。 尽管这两种技术适用于身份，他们处理完全不同的问题 （尽管 Microsoft 说它期望集成在某些时候两个）。

使用标识是在几乎每个应用程序中的重要。 访问控制的目的是为了方便开发人员创建应用程序，接受来自不同身份提供商的身份。 通过将此服务放在云中，Microsoft 已在任何平台上运行的任何应用程序使用。

##<a name="about-the-author"></a>关于作者

David Chappell 是主体的 Chappell 和合伙人[www.davidchappell.com](http://www.davidchappell.com)在旧金山，加利福尼亚州。
